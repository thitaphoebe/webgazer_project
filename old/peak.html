<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ติดตามสายตาและอ่านคำ</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
      text-align: center;
    }

    #tracker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: red;
      position: fixed;
      pointer-events: none;
      z-index: 10;
      transition: top 0.15s linear, left 0.15s linear;
    }

    .calibration {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: red;
      position: absolute;
      cursor: pointer;
      opacity: 0.7;
      z-index: 5;
    }

    #instructions {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }

    #centerDot {
      width: 20px;
      height: 20px;
      background-color: blue;
      border-radius: 50%;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
    }

    #accuracy {
      font-size: 24px;
      margin-top: 10px;
      color: green;
    }

    #thaiSentence {
      font-size: 192px;
      font-weight: bold;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      display: none;
      white-space: nowrap;
    }

    .word {
      padding: 0 10px;
      transition: background-color 0.3s ease;
    }

    .highlight-yellow {
      background-color: yellow;
    }

    .highlight-green {
      background-color: limegreen;
      color: white;
    }
  </style>
</head>
<body>

<div id="tracker"></div>
<div id="instructions">โปรดคลิกจุดสีแดงแต่ละจุด 3 ครั้งเพื่อตั้งค่าการสอบเทียบ</div>
<div id="centerDot"></div>
<div id="accuracy"></div>
<div id="thaiSentence"></div>

<!-- Calibration Dots -->
<div class="calibration" style="top:10%; left:5%;"></div>
<div class="calibration" style="top:10%; left:45%;"></div>
<div class="calibration" style="top:10%; left:80%;"></div>
<div class="calibration" style="top:40%; left:5%;"></div>
<div class="calibration" style="top:40%; left:45%;"></div>
<div class="calibration" style="top:40%; left:80%;"></div>
<div class="calibration" style="top:75%; left:5%;"></div>
<div class="calibration" style="top:75%; left:45%;"></div>
<div class="calibration" style="top:75%; left:80%;"></div>

<script>
  const tracker = document.getElementById("tracker");
  const centerDot = document.getElementById("centerDot");
  const instructions = document.getElementById("instructions");
  const accuracyDiv = document.getElementById("accuracy");
  const sentenceDiv = document.getElementById("thaiSentence");

  const sentence = "ฉัน รัก เรียน รู้";
  const words = sentence.split(" ");

  // สร้าง span สำหรับคำแต่ละคำ
  words.forEach(word => {
    const span = document.createElement("span");
    span.className = "word";
    span.innerText = word;
    sentenceDiv.appendChild(span);
  });

  let spokenWords = new Set();
  let wordTimers = new Map();
  let gazeData = [];

  // เตรียมระบบเลือกเสียงไทย
  let thaiVoices = [];
  let selectedThaiVoice = null;
  speechSynthesis.onvoiceschanged = () => {
    thaiVoices = speechSynthesis.getVoices().filter(v => v.lang === 'th-TH');
    if (thaiVoices.length) {
      selectedThaiVoice = thaiVoices[0];
      console.log('Selected Thai voice:', selectedThaiVoice.name);
    }
  };

  // Setup WebGazer
  webgazer.setGazeListener((data) => {
    if (!data) return;

    tracker.style.left = `${data.x - 10}px`;
    tracker.style.top = `${data.y - 10}px`;

    // หากกำลังเก็บข้อมูล Accuracy
    if (collectingAccuracy) {
      gazeData.push({ x: data.x, y: data.y });
    }

    document.querySelectorAll(".word").forEach(span => {
      const rect = span.getBoundingClientRect();
      if (
        data.x >= rect.left &&
        data.x <= rect.right &&
        data.y >= rect.top &&
        data.y <= rect.bottom
      ) {
        span.classList.add("highlight-yellow");

        if (!wordTimers.has(span)) {
          const timer = setTimeout(() => {
            span.classList.remove("highlight-yellow");
            span.classList.add("highlight-green");

            if (!spokenWords.has(span.innerText)) {
              const utter = new SpeechSynthesisUtterance(span.innerText);
              utter.lang = "th-TH";
              if (selectedThaiVoice) utter.voice = selectedThaiVoice;
              speechSynthesis.speak(utter);
              spokenWords.add(span.innerText);
            }
          }, 1000);
          wordTimers.set(span, timer);
        }
      } else {
        span.classList.remove("highlight-yellow");
        if (wordTimers.has(span)) {
          clearTimeout(wordTimers.get(span));
          wordTimers.delete(span);
        }
      }
    });
  }).begin();

  // Calibration process
  const dots = document.querySelectorAll(".calibration");
  const clickCounts = Array(dots.length).fill(0);
  const clicksPerDot = 3;
  let completedDots = 0;

  dots.forEach((dot, i) => {
    dot.addEventListener("click", () => {
      clickCounts[i]++;
      if (clickCounts[i] >= clicksPerDot) {
        dot.style.backgroundColor = "green";
        dot.style.pointerEvents = "none";
        completedDots++;
      } else {
        dot.style.opacity = 0.4 + (clickCounts[i] / clicksPerDot) * 0.6;
      }

      if (completedDots === dots.length) {
        instructions.innerText = "กรุณามองจุดสีน้ำเงินตรงกลางหน้าจอ 3 วินาที...";
        dots.forEach(d => d.remove());
        centerDot.style.display = "block";
        startAccuracyCheck();
      }
    });
  });

  let collectingAccuracy = false;

  function startAccuracyCheck() {
    gazeData = [];
    collectingAccuracy = true;

    setTimeout(() => {
      collectingAccuracy = false;
      centerDot.style.display = "none";
      calculateAccuracy();
    }, 3000);
  }

  function calculateAccuracy() {
    if (gazeData.length === 0) {
      accuracyDiv.innerText = "ไม่สามารถคำนวณความแม่นยำได้";
      return;
    }

    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2;

    let totalDist = 0;

    gazeData.forEach(({ x, y }) => {
      const dx = x - centerX;
      const dy = y - centerY;
      totalDist += Math.sqrt(dx * dx + dy * dy);
    });

    const avgDist = totalDist / gazeData.length;
    const maxDist = Math.sqrt(window.innerWidth ** 2 + window.innerHeight ** 2);
    const accuracy = Math.max(0, 100 - (avgDist / maxDist) * 100);

    accuracyDiv.innerText = `ความแม่นยำประมาณ: ${accuracy.toFixed(2)}%`;
    instructions.innerText = "เริ่มติดตามคำได้แล้ว!";
    sentenceDiv.style.display = "block";
  }
</script>
</body>
</html>
