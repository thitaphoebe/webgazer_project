<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Eye Tracking Thai Sentence</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;text-align:center;overflow:hidden}
    #tracker{width:20px;height:20px;background:red;border-radius:50%;position:fixed;top:0;left:0;pointer-events:none;z-index:10;transition:top .1s linear,left .1s linear}
    .calibration{width:30px;height:30px;border-radius:50%;background:red;position:absolute;cursor:pointer;opacity:.7;z-index:5}
    #centerDot{width:20px;height:20px;background:blue;border-radius:50%;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);display:none}
    #instructions{margin-top:20px;font-size:20px;font-weight:bold}
    #progress{font-size:20px;margin-top:6px}
    #accuracy{font-size:24px;margin-top:10px;color:green}
    #thaiSentence{font-weight:bold;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;display:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis}
    .word{padding:0 10px;transition:background-color .3s ease;display:inline-block;white-space:nowrap;margin:0 20px}
    .highlight-yellow{background:yellow}
    .highlight-green{background:limegreen;color:#fff}
    #userForm,#levelSelect{display:none;margin-top:20px}
    #recalBtn{position:fixed;top:10px;right:10px;z-index:11;font-size:18px;padding:4px 10px;display:none}
  </style>
</head>
<body>
  <div id="tracker"></div>
  <div id="instructions">‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div>
  <div id="progress"></div>
  <div id="centerDot"></div>
  <div id="accuracy"></div>
  <div id="thaiSentence"></div>

  <button id="recalBtn">üîÑ Re-calibrate</button>

  <div id="userForm">
    <label>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠: <input type="text" id="userName" /></label>
    <button onclick="submitName()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
  </div>

  <div id="levelSelect">
    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö:</p>
    <button onclick="selectLevel('‡∏õ1')">‡∏õ.1</button>
    <button onclick="selectLevel('‡∏õ2')">‡∏õ.2</button>
    <button onclick="selectLevel('‡∏õ3')">‡∏õ.3</button>
  </div>

<script>
/* ---------- sentence sets ---------- */
const sentenceSets={ /* ... unchanged ... */ };
sentenceSets["‡∏õ1"]=[ "‡∏û‡πà‡∏≠ ‡∏ä‡∏≠‡∏ö ‡∏î‡∏π ‡∏õ‡∏•‡∏≤","‡∏â‡∏±‡∏ô ‡∏£‡∏±‡∏Å ‡∏û‡πà‡∏≠ ‡πÅ‡∏°‡πà","‡∏ï‡∏≤ ‡∏´‡∏≤ ‡∏õ‡∏π ‡∏ô‡∏≤","‡∏ô‡πâ‡∏≠‡∏á ‡∏Å‡∏¥‡∏ô ‡∏•‡∏π‡∏Å ‡∏ó‡πâ‡∏≠","‡∏•‡∏¥‡∏á ‡∏à‡∏±‡∏ö ‡∏Å‡∏¥‡πà‡∏á ‡πÑ‡∏°‡πâ",
  "‡πÅ‡∏°‡πà ‡πÄ‡∏î‡πá‡∏î ‡∏î‡∏≠‡∏Å ‡πÑ‡∏°‡πâ","‡∏â‡∏±‡∏ô ‡∏ô‡∏≠‡∏ô ‡∏ö‡∏ô ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á","‡πÄ‡∏î‡πá‡∏Å ‡∏´‡∏ç‡∏¥‡∏á ‡∏ß‡∏¥‡πà‡∏á ‡πÄ‡∏•‡πà‡∏ô","‡∏Ñ‡∏£‡∏π ‡∏¢‡∏∑‡∏ô ‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡πâ‡∏≠‡∏á","‡∏•‡∏π‡∏Å ‡πÅ‡∏°‡∏ß ‡∏î‡∏∑‡πà‡∏° ‡∏ô‡∏°" ];
sentenceSets["‡∏õ2"]=[ "‡∏ï‡∏≥‡∏£‡∏ß‡∏à ‡πÄ‡∏î‡∏¥‡∏ô ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏£‡∏≤","‡∏î‡∏¥‡∏ô ‡∏ñ‡∏•‡πà‡∏° ‡∏à‡∏≤‡∏Å ‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","‡∏¢‡πà‡∏≤‡∏á ‡∏õ‡∏•‡∏≤ ‡∏ö‡∏ô ‡∏ï‡∏∞‡πÅ‡∏Å‡∏£‡∏á","‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏î‡∏µ",
  "‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏£‡∏π ‡∏™‡∏≠‡∏ô ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠","‡πÄ‡∏ò‡∏≠ ‡∏£‡πâ‡∏≠‡∏á ‡∏Ñ‡∏£‡∏ß‡∏ç ‡∏Ñ‡∏£‡∏≤‡∏á","‡πÅ‡∏°‡∏ß ‡∏Å‡∏¥‡∏ô ‡∏õ‡∏•‡∏≤ ‡∏û‡∏∏‡∏á ‡∏Å‡∏•‡∏°","‡∏û‡∏µ‡πà ‡πÄ‡∏•‡πà‡∏ô ‡∏î‡∏ô‡∏ï‡∏£‡∏µ ‡πÑ‡∏û‡πÄ‡∏£‡∏≤‡∏∞",
  "‡πÄ‡∏î‡πá‡∏Å ‡∏´‡∏ç‡∏¥‡∏á ‡∏ß‡∏¥‡πà‡∏á ‡∏£‡∏≠‡∏ö ‡∏ö‡πâ‡∏≤‡∏ô","‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏£‡∏π ‡∏™‡∏≠‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï" ];
sentenceSets["‡∏õ3"]=[ "‡∏õ‡πä‡∏∞‡∏õ‡πã‡∏≤ ‡πÑ‡∏õ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏á‡∏≤‡∏ô","‡πÄ‡∏ò‡∏≠ ‡∏ó‡∏≥ ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‡πÄ‡∏ï‡πá‡∏° ‡∏ó‡∏µ‡πà","‡∏•‡∏∏‡∏á ‡πÄ‡∏î‡∏¥‡∏ô ‡πÇ‡∏Ç‡∏¢‡∏Å‡πÄ‡∏Ç‡∏¢‡∏Å","‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏î‡∏±‡∏á ‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ß‡∏à‡πä‡∏≤‡∏ß",
  "‡πÄ‡∏Ç‡∏≤ ‡πÑ‡∏õ ‡∏á‡∏≤‡∏ô ‡∏£‡∏ß‡∏° ‡∏ç‡∏≤‡∏ï‡∏¥","‡∏û‡∏µ‡πà ‡πÑ‡∏î‡πâ ‡πÉ‡∏ö ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡∏´‡∏≤ ‡∏á‡∏≤‡∏ô","‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏ï‡πâ‡∏≠‡∏á ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏Å‡∏±‡∏ô","‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß ‡∏£‡πâ‡∏≠‡∏á ‡πÄ‡∏û‡∏•‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞",
  "‡∏û‡πà‡∏≠ ‡∏Ç‡∏±‡∏ö ‡∏£‡∏ñ ‡πÑ‡∏õ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô","‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏ä‡∏ß‡∏ô ‡πÑ‡∏õ ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß" ];

/* ---------- DOM ---------- */
const tracker=document.getElementById("tracker"), centerDot=document.getElementById("centerDot");
const instructions=document.getElementById("instructions"), accuracyDiv=document.getElementById("accuracy");
const sentenceDiv=document.getElementById("thaiSentence"), progressDiv=document.getElementById("progress");
const recalBtn=document.getElementById("recalBtn");

/* ---------- globals ---------- */
let userName="", userLevel="", sentenceList=[];
let gazeLog=[], currentSentenceNumber=1, startTime=null;
const maxSentences=10;

/* stability params */
const SAMPLE_INTERVAL=66, REQUIRED_SAMPLES=5;
let lastProcess=0; const spanCounts=new Map();

/* calibration state */
const gridSize=4, clicksPerDot=3; let completedDots=0, clickCounts=[];
let recalibrating=false, accuracyData=[];

/* ---------- user workflow ---------- */
function submitName(){ /* unchanged */ 
  userName=document.getElementById("userName").value.trim();
  if(userName){ document.getElementById("userForm").style.display="none";
                document.getElementById("levelSelect").style.display="block"; }
}
function selectLevel(level){ /* unchanged core */
  userLevel=level; sentenceList=[...sentenceSets[level]];
  document.getElementById("levelSelect").style.display="none";
  instructions.textContent="‡∏Å‡∏î Spacebar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
  sentenceDiv.style.display="block"; recalBtn.style.display="block";
  currentSentenceNumber=1; renderSentence();
}

/* ---------- rendering ---------- */
function renderSentence(){
  if(currentSentenceNumber>maxSentences){saveCSV(); return;}
  progressDiv.textContent=`‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà ${currentSentenceNumber} / ${maxSentences}`;
  const idx=Math.floor(Math.random()*sentenceList.length);
  const sent=sentenceList.splice(idx,1)[0];
  sentenceDiv.innerHTML="";
  sent.split(" ").forEach(w=>{
    const sp=document.createElement("span");
    sp.className="word"; sp.textContent=w;
    if(userLevel==="‡∏õ1") sp.style.margin="0 20px";
    sentenceDiv.appendChild(sp);
  });
  adjustFont(); spanCounts.clear();
}
function adjustFont(){ let s=100; sentenceDiv.style.fontSize=s+"px";
  while(sentenceDiv.scrollWidth>innerWidth*0.9 && s>10){s-=2; sentenceDiv.style.fontSize=s+"px";}
}

/* ---------- CSV ---------- */
function saveCSV(){
  progressDiv.textContent="";
  const header=["x","y","sentenceNumber","highlight","word","timeSec"];
  const blob=new Blob([ [header.join(",")].concat(
      gazeLog.map(r=>[r.x,r.y,r.sentenceNumber,r.highlight,r.word,r.time].join(",")) ).join("\n") ],
      {type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download=`${userName}_lv${userLevel}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  instructions.textContent="‚úîÔ∏è ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
}

/* ---------- calibration helpers (unchanged logic) ---------- */
function showDots(){ /* unchanged */ document.querySelectorAll(".calibration").forEach(e=>e.remove());
  completedDots=0; clickCounts=[];
  for(let r=0;r<gridSize;r++)for(let c=0;c<gridSize;c++){
    const d=document.createElement("div"); d.className="calibration";
    d.style.top=`${5+r* (90/(gridSize-1))}%`; d.style.left=`${5+c*(90/(gridSize-1))}%`;
    document.body.appendChild(d);
  }
  document.querySelectorAll(".calibration").forEach((dot,i)=>{
    clickCounts[i]=0;
    dot.addEventListener("click",()=>{
      if(++clickCounts[i]>=clicksPerDot){
        dot.style.background="green"; dot.style.pointerEvents="none"; completedDots++;
        if(completedDots===gridSize*gridSize){
          instructions.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥... ‡∏°‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô";
          document.querySelectorAll(".calibration").forEach(d=>d.remove());
          centerDot.style.display="block"; measureAccuracy();
        }
      }else dot.style.opacity=0.4+(clickCounts[i]/clicksPerDot)*0.6;
    });
  });
}
function measureAccuracy(){
  accuracyData=[]; let n=0;
  const t=setInterval(()=>{
    if(window.lastGaze) accuracyData.push({x:lastGaze.x,y:lastGaze.y});
    if(++n>30){clearInterval(t); centerDot.style.display="none";
      accuracyDiv.textContent="üìè Accuracy: "+calcAcc();
      if(recalibrating){ sentenceDiv.style.display="block"; recalBtn.style.display="block"; recalibrating=false; }
      else{ if(!startTime) startTime=performance.now(); document.getElementById("userForm").style.display="block"; }
    }
  },100);
}
function calcAcc(){ if(!accuracyData.length) return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ";
  const cx=innerWidth/2, cy=innerHeight/2;
  const avg=accuracyData.reduce((s,p)=>s+Math.hypot(p.x-cx,p.y-cy),0)/accuracyData.length;
  return (Math.max(0,100-avg/Math.hypot(cx,cy)*100)).toFixed(2)+"%"; }

/* ---------- recalibrate ---------- */
function startRecal(){ recalibrating=true; sentenceDiv.style.display="none"; recalBtn.style.display="none";
  accuracyDiv.textContent=""; instructions.textContent="‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö"; showDots();}
recalBtn.addEventListener("click",startRecal);

/* ---------- init ---------- */
window.addEventListener("load",showDots);

/* ---------- WebGazer listener (NEW logging) ---------- */
webgazer.setGazeListener(data=>{
  if(!data) return;

  /* always update tracker & cache for accuracy */
  window.lastGaze=data;
  tracker.style.left=`${data.x-10}px`; tracker.style.top=`${data.y-10}px`;

  /* ignore reading-phase until master timer starts */
  if(startTime===null) return;

  /* throttle */
  const now=performance.now(); if(now-lastProcess<SAMPLE_INTERVAL) return; lastProcess=now;

  /* Determine current word + manage highlights */
  let lookedSpan=null;
  document.querySelectorAll(".word").forEach(span=>{
    const r=span.getBoundingClientRect();
    const inside=data.x>=r.left&&data.x<=r.right&&data.y>=r.top&&data.y<=r.bottom;

    let cnt=spanCounts.get(span)||0;
    if(inside){ lookedSpan=span; cnt++; spanCounts.set(span,cnt);
      if(!span.classList.contains("highlight-yellow")) span.classList.add("highlight-yellow");
      if(cnt>=REQUIRED_SAMPLES && !span.classList.contains("highlight-green")){
        span.classList.replace("highlight-yellow","highlight-green");
        const u=new SpeechSynthesisUtterance(span.textContent); u.lang="th-TH"; speechSynthesis.speak(u);
      }
    }else{ cnt=0; spanCounts.set(span,cnt); span.classList.remove("highlight-yellow","highlight-green"); }
  });

  /* Gather log entry */
  const word  = lookedSpan ? lookedSpan.textContent : "";
  const hilite= lookedSpan ? (lookedSpan.classList.contains("highlight-green")?"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß":
                              (lookedSpan.classList.contains("highlight-yellow")?"‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á":"")) : "";
  gazeLog.push({ x:data.x.toFixed(2), y:data.y.toFixed(2),
                 sentenceNumber:currentSentenceNumber, word, highlight:hilite,
                 time:((now-startTime)/1000).toFixed(2) });
}).begin();

/* ---------- keyboard ---------- */
document.addEventListener("keydown",e=>{
  if(e.code==="Space" && sentenceDiv.style.display!=="none"){
    speechSynthesis.cancel(); spanCounts.clear();
    document.querySelectorAll(".word").forEach(s=>s.classList.remove("highlight-yellow","highlight-green"));
    currentSentenceNumber++; renderSentence();
  }
});
</script>
</body>
</html>
